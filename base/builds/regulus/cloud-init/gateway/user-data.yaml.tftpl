#cloud-config
hostname: router-test
timezone: America/Toronto
bootcmd:
  - sysctl -w net.ipv4.ip_forward=1
write_files:
  - path: /etc/sysctl.d/99-ipv.conf
    content: |
      net.ipv4.ip_forward = 1
    owner: 'root:root'
    permissions: '0644'
  - path: /etc/haproxy/haproxy.config
    content: |
      global
        maxconn 8192
        log 127.0.0.1 local0
        user haproxy
        group haproxy
        chroot /var/empty
      defaults
        mode http
        balance roundrobin
      frontend cluster_apps
        bind :80
        default_backend default_ingress
      backend default_ingress
        server master0 192.168.64.4:80
        server master1 192.168.64.5:80
        server master2 192.168.64.6:80
      backend cluster_api
        server master0 192.168.64.4:6443
        server master1 192.168.64.5:6443
        server master2 192.168.64.6:6443
users:
  - default
  - name: tkjode
    groups:
      - sudo
    shell: /bin/bash
    ssh_import_id: ['gh:tkjode']
    sudo: ALL=(ALL) NOPASSWD:ALL
package_update: true
packages:
  - qemu-guest-agent
  - net-tools
  - curl
  - haproxy
runcmd:
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
  - iptables -A FORWARD -i eth0 -i eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
  - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
  - echo "done" > /tmp/cloud-config.done